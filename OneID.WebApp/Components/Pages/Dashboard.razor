@page "/dashboard"
@rendermode InteractiveServer
@inject NavigationManager Navigation
@inject IHttpContextAccessor HttpContextAccessor
@inject IHttpClientFactory HttpClientFactory
@inject IJSRuntime JS

@using System.IdentityModel.Tokens.Jwt
@using System.Net.Http.Headers
@using System.Text.Json

<div class="top-bar">
    Bem-vindo, @OperatorName (@Email)<br />
    Conta: @AccountId
</div>

<div class="grid-layout">
    <div class="pending-widget">
        <h2>Processos pendentes de confirmação</h2>
        <ul>
            @foreach (var item in PendingProcesses.Take(ExpandGrid ? PendingProcesses.Count : 5))
            {
                <li>
                    <div style="display: flex; flex-direction: column;">
                        <span>@item.FullName</span>
                        <div style="font-size: 0.75rem; color: var(--text-muted); display: flex; align-items: center; gap: 0.4rem;">
                            <span>@item.CorrelationId</span>
                            <svg @onclick="@(() => CopiarId(item.CorrelationId))"
                                 xmlns="http://www.w3.org/2000/svg"
                                 viewBox="0 0 24 24"
                                 style="width: 14px; height: 14px; fill: var(--highlight-color); cursor: pointer;">
                                <path d="M16 1H4a2 2 0 0 0-2 2v14h2V3h12V1zm3 4H8a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h11a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2zm0 16H8V7h11v14z" />
                            </svg>
                        </div>
                    </div>
                    <button class="resume-button" @onclick="() => Retomar(item.CorrelationId)">Retomar</button>
                </li>
            }
        </ul>

        <a @onclick="ToggleExpand" class="footer-link" style="cursor: pointer;">
            @(ExpandGrid ? "Ver menos ⤵" : "Ver todos ⤴")
        </a>

    </div>

    <div class="pending-widget">
        <h2>Status do OneID</h2>
        <ul>
            <li><span>Autenticação</span><span style="color: #10b981;">Online</span></li>
            <li><span>Provisionamento</span><span style="color: #10b981;">Online</span></li>
            <li><span>Comunicação externa</span><span style="color: #10b981;">Online</span></li>
        </ul>
        <div style="margin-top: 1rem; font-size: 0.85rem; color: var(--text-muted); text-align: right;">
            Última verificação: @LastChecked
        </div>
    </div>
</div>

<div class="grid-layout">
    <div class="admissions-widget">
        <h2>Admissões recentes</h2>
        <ul>
            @foreach (var item in RecentAdmissions.Take(10))
            {
                <li>
                    <div class="date-box">
                        <div class="month">@item.ProvisioningAt.ToString("MMM").ToUpper()</div>
                        <div class="day">@item.ProvisioningAt.Day</div>
                    </div>
                    <div class="admission-info">
                        <strong>@item.FullName</strong>
                        <div class="muted">@item.JobTitleName</div>
                        <div class="muted">@item.DepartmentName</div>
                        <div class="muted">@item.Company</div>
                        <div class="muted">Manager: @item.LoginManager</div>
                        <div class="muted" title="@item.AccountId">ID: @item.AccountId[..8]...</div>
                    </div>
                </li>
            }
        </ul>
    </div>
</div>


@code {
    private string OperatorName = "usuário";
    private string AccountId = "desconhecido";
    private string Email = "não informado";
    private List<PendingProcessDto> PendingProcesses = [];
    private bool ExpandGrid = false;
    private string LastChecked = string.Empty;
    private List<RecentAdmissionDto> RecentAdmissions = [];

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;

        ExpandGrid = await JS.InvokeAsync<bool>("dashboardState.getExpandState");

        var request = HttpContextAccessor.HttpContext?.Request;
        var token = request?.Cookies["access_token"];
        if (string.IsNullOrWhiteSpace(token)) return;

        var handler = new JwtSecurityTokenHandler();
        try
        {
            var jwt = handler.ReadJwtToken(token);
            OperatorName = jwt.Claims.FirstOrDefault(c => c.Type == "name")?.Value ?? "usuário";
            Email = jwt.Claims.FirstOrDefault(c => c.Type == "email")?.Value ?? "não informado";
            AccountId = jwt.Claims.FirstOrDefault(c => c.Type == "account_id")?.Value ?? "desconhecido";
        }
        catch
        {
            OperatorName = "erro ao ler token";
        }

        var client = HttpClientFactory.CreateClient();
        client.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", token);

        var response = await client.GetAsync("https://localhost:7200/v1/pendings");
        if (response.IsSuccessStatusCode)
        {
            var list = await response.Content.ReadFromJsonAsync<List<PendingProcessDto>>();
            PendingProcesses = list ?? [];
        }

        await LoadRecentAdmissions();

        LastChecked = DateTime.UtcNow.ToLocalTime().ToString("HH:mm:ss");

        StateHasChanged();
    }

    private async Task Retomar(string correlationId)
    {
        var token = HttpContextAccessor.HttpContext?.Request.Cookies["access_token"];
        if (string.IsNullOrWhiteSpace(token)) return;

        var client = HttpClientFactory.CreateClient();
        client.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", token);

        var payload = new { CorrelationId = correlationId };
        var response = await client.PostAsJsonAsync("https://localhost:7200/v1/staging/resume", payload);

        if (!response.IsSuccessStatusCode) return;

        var json = await response.Content.ReadFromJsonAsync<JsonElement>();
        var requestToken = json.GetProperty("token").GetString();
        var resumedCorrelationId = json.GetProperty("correlationId").GetString();

        // JS para definir cookies client-side
        await JS.InvokeVoidAsync("OneID.setCookie", "correlation_id", resumedCorrelationId, 5);
        await JS.InvokeVoidAsync("OneID.setCookie", "request_token", requestToken, 5);

        Navigation.NavigateTo("https://localhost:5001/confirm-code", forceLoad: true);
    }

    private void CopiarId(string id)
    {
        JS.InvokeVoidAsync("OneID.copyToClipboard", id);
    }

    private async Task ToggleExpand()
    {
        ExpandGrid = !ExpandGrid;
        await JS.InvokeVoidAsync("dashboardState.saveExpandState", ExpandGrid);
    }

    private async Task LoadRecentAdmissions()
    {
        var token = HttpContextAccessor.HttpContext?.Request.Cookies["access_token"];
        if (string.IsNullOrWhiteSpace(token)) return;

        var client = HttpClientFactory.CreateClient();
        client.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", token);

        var response = await client.GetAsync("https://localhost:7200/v1/staging/admissions-recents?limit=10");
        if (response.IsSuccessStatusCode)
        {
            var list = await response.Content.ReadFromJsonAsync<List<RecentAdmissionDto>>();
            RecentAdmissions = list ?? [];
        }
    }

    public class PendingProcessDto
    {
        public string CorrelationId { get; set; } = string.Empty;
        public string FullName { get; set; } = string.Empty;
        public DateTime CreatedAt { get; set; }
    }

    public class RecentAdmissionDto
    {
        public DateTimeOffset ProvisioningAt { get; set; }
        public string FullName { get; set; } = string.Empty;
        public string JobTitleName { get; set; } = string.Empty;
        public string DepartmentName { get; set; } = string.Empty;
        public string Company { get; set; } = string.Empty;
        public string LoginManager { get; set; } = string.Empty;
        public string AccountId { get; set; } = string.Empty;
    }

}
