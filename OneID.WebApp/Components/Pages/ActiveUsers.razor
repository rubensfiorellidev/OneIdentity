@page "/active-users"
@rendermode InteractiveServer
@inject NavigationManager Navigation

@using System.Text
@using System.Globalization
@using System.Timers
@using OneID.WebApp.Components
@using OneID.WebApp.Interfaces

@inject IOneIdUserService UserService

<PageTitle>Usuários Ativos</PageTitle>

<div class="card">
    <div class="active-users-header">
        <h1>Usuários</h1>
        <div class="search-actions-wrapper">
            <div class="search-container">
                <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" stroke="var(--text-muted)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8" /><line x1="21" y1="21" x2="16.65" y2="16.65" /></svg>
                <input type="text" class="search-box" placeholder="Pesquisar no IAM" @bind="SearchTerm" @bind:event="oninput" />
            </div>
            <button class="create-user-button" @onclick="CreateUser">Criar usuário</button>
        </div>
    </div>

    <div class="table-container">
        <table class="user-table">
            <thead>
                <tr>
                    <th><input type="checkbox" @onchange="ToggleSelectAll" /></th>
                    <th @onclick="() => SortBy(nameof(ActiveUserViewModel.FullName))">Nome do usuário</th>
                    <th @onclick="() => SortBy(nameof(ActiveUserViewModel.JobTitleName))">Cargo</th>
                    <th @onclick="() => SortBy(nameof(ActiveUserViewModel.DepartmentName))">Departamento</th>
                    <th @onclick="() => SortBy(nameof(ActiveUserViewModel.Company))">Empresa</th>
                    <th @onclick="() => SortBy(nameof(ActiveUserViewModel.Login))">Login</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var user in FilteredUsers)
                {
                    var isActive = user.Status.ToLowerInvariant() == "ativo";
                    <tr>
                        <td><input type="checkbox" @bind="user.IsSelected" /></td>
                        <td>
                            <a href="/user-details/@user.Id" class="user-name-link">
                                <span class="status-indicator @(isActive ? "green" : "red")"></span>
                                <span>@user.FullName</span>
                            </a>
                        </td>
                        <td class="pipe">@user.JobTitleName</td>
                        <td class="pipe">@user.DepartmentName</td>
                        <td class="pipe">@user.Company</td>
                        <td class="pipe">@user.Login</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

@code {
    private List<ActiveUserViewModel> AllUsers = [];
    private List<ActiveUserViewModel> FilteredUsers = [];

    private string _searchTerm = string.Empty;
    private Timer? _debounceTimer;

    public string SearchTerm
    {
        get => _searchTerm;
        set
        {
            _searchTerm = value;

            _debounceTimer?.Stop();
            _debounceTimer = new Timer(300);
            _debounceTimer.Elapsed += (_, _) =>
            {
                _debounceTimer.Dispose();
                _debounceTimer = null;
                InvokeAsync(ApplySearch);
            };
            _debounceTimer.Start();
        }
    }

    private string SortColumn = string.Empty;
    private bool SortAsc = true;

    private void SortBy(string column)
    {
        if (SortColumn == column)
            SortAsc = !SortAsc;
        else
        {
            SortColumn = column;
            SortAsc = true;
        }

        FilteredUsers = SortAsc
            ? FilteredUsers.OrderBy(u => GetPropertyValue(u, column)).ToList()
            : FilteredUsers.OrderByDescending(u => GetPropertyValue(u, column)).ToList();

        StateHasChanged();
    }

    private static object? GetPropertyValue(object obj, string prop)
    {
        return obj.GetType().GetProperty(prop)?.GetValue(obj, null);
    }

    private int SelectedCount => FilteredUsers.Count(u => u.IsSelected);

    protected override async Task OnInitializedAsync()
    {
        AllUsers = await UserService.GetActiveUsersAsync();
        FilteredUsers = AllUsers;
    }

    private void ToggleSelectAll(ChangeEventArgs e)
    {
        bool isChecked = (bool)e.Value!;
        foreach (var user in FilteredUsers)
            user.IsSelected = isChecked;
    }

    private void ApplySearch()
    {
        var normalizedTerm = Normalize(SearchTerm);

        FilteredUsers = string.IsNullOrWhiteSpace(normalizedTerm)
            ? AllUsers
            : AllUsers.Where(u =>
                  Normalize(u.FullName).Contains(normalizedTerm)
                  || Normalize(u.Login).Contains(normalizedTerm)
                  || Normalize(u.JobTitleName).Contains(normalizedTerm)
                  || Normalize(u.DepartmentName).Contains(normalizedTerm))
              .ToList();

        StateHasChanged();
    }

    private static string Normalize(string input)
    {
        if (string.IsNullOrWhiteSpace(input)) return string.Empty;

        var normalized = input.Normalize(NormalizationForm.FormD);
        var sb = new StringBuilder();
        foreach (var c in normalized)
        {
            if (CharUnicodeInfo.GetUnicodeCategory(c) != UnicodeCategory.NonSpacingMark)
                sb.Append(c);
        }
        return sb.ToString().ToLowerInvariant();
    }

    private void CreateUser()
    {
        // Redirecionar para rota de criação
        Navigation.NavigateTo("/create-user");
    }

    public class ActiveUserViewModel
    {
        public string Id { get; set; } = string.Empty;
        public string FullName { get; set; } = string.Empty;
        public string JobTitleName { get; set; } = string.Empty;
        public string DepartmentName { get; set; } = string.Empty;
        public string Company { get; set; } = string.Empty;
        public string Login { get; set; } = string.Empty;
        public string Status { get; set; } = string.Empty;
        public bool IsSelected { get; set; } = false;
    }
}