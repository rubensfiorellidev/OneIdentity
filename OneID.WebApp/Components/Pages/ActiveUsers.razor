@page "/active-users"
@rendermode InteractiveServer

@using System.Text
@using System.Globalization
@using System.Timers
@using OneID.WebApp.Components
@using OneID.WebApp.Interfaces

@inject IOneIdUserService UserService

<PageTitle>Usuários Ativos</PageTitle>

<div class="card">
    <div class="card-header flex-between">
        <div class="flex-center">
            <input type="checkbox" @onchange="ToggleSelectAll" />
            <input class="search-box" type="text" placeholder="Pesquisar" @bind="SearchTerm" @bind:event="oninput" />
            <button class="search-button" @onclick="ApplySearch">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-search">
                    <circle cx="11" cy="11" r="8" />
                    <path d="m21 21-4.35-4.35" />
                </svg>
            </button>
        </div>
    </div>

    <div class="table-container">
        <table class="user-table">
            <thead>
                <tr>
                    <th></th>
                    <th>Nome</th>
                    <th>Cargo</th>
                    <th>Departamento</th>
                    <th>Empresa</th>
                    <th>Login</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var user in FilteredUsers)
                {
                    <tr>
                        <td>
                            <input type="checkbox" @bind="user.IsSelected" />
                        </td>
                        <td>
                            <a href="/user-details/@user.Id" class="link-with-icon">
                                <span class="status-indicator active"></span>
                                <span>@user.FullName</span>
                                <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-external-link">
                                    <path d="M18 13v6a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6" />
                                    <polyline points="15 3 21 3 21 9" />
                                    <line x1="10" x2="21" y1="14" y2="3" />
                                </svg>
                            </a>
                        </td>
                        <td>@user.JobTitleName</td>
                        <td>@user.DepartmentName</td>
                        <td>@user.Company</td>
                        <td>@user.Login</td>
                        <td class="status">@user.Status</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

@code {
    private List<ActiveUserViewModel> AllUsers = [];
    private List<ActiveUserViewModel> FilteredUsers = [];

    private string _searchTerm = string.Empty;
    private Timer? _debounceTimer;

    public string SearchTerm
    {
        get => _searchTerm;
        set
        {
            _searchTerm = value;

            _debounceTimer?.Stop();
            _debounceTimer = new Timer(300); // 300ms debounce
            _debounceTimer.Elapsed += (_, _) =>
            {
                _debounceTimer.Dispose();
                _debounceTimer = null;
                InvokeAsync(ApplySearch);
            };
            _debounceTimer.Start();
        }
    }

    private int SelectedCount => FilteredUsers.Count(u => u.IsSelected);

    protected override async Task OnInitializedAsync()
    {
        AllUsers = await UserService.GetActiveUsersAsync();
        FilteredUsers = AllUsers;
    }

    private void ToggleSelectAll(ChangeEventArgs e)
    {
        bool isChecked = (bool)e.Value!;
        foreach (var user in FilteredUsers)
            user.IsSelected = isChecked;
    }

    private void ApplySearch()
    {
        var normalizedTerm = Normalize(SearchTerm);

        FilteredUsers = string.IsNullOrWhiteSpace(normalizedTerm)
            ? AllUsers
            : AllUsers.Where(u =>
                  Normalize(u.FullName).Contains(normalizedTerm)
                  || Normalize(u.Login).Contains(normalizedTerm)
                  || Normalize(u.JobTitleName).Contains(normalizedTerm)
                  || Normalize(u.DepartmentName).Contains(normalizedTerm))
              .ToList();

        StateHasChanged();
    }

    private static string Normalize(string input)
    {
        if (string.IsNullOrWhiteSpace(input)) return string.Empty;

        var normalized = input.Normalize(NormalizationForm.FormD);
        var sb = new StringBuilder();
        foreach (var c in normalized)
        {
            if (CharUnicodeInfo.GetUnicodeCategory(c) != UnicodeCategory.NonSpacingMark)
                sb.Append(c);
        }
        return sb.ToString().ToLowerInvariant();
    }

    public class ActiveUserViewModel
    {
        public string Id { get; set; } = string.Empty;
        public string FullName { get; set; } = string.Empty;
        public string JobTitleName { get; set; } = string.Empty;
        public string DepartmentName { get; set; } = string.Empty;
        public string Company { get; set; } = string.Empty;
        public string Login { get; set; } = string.Empty;
        public string Status { get; set; } = string.Empty;
        public bool IsSelected { get; set; } = false;
    }
}
